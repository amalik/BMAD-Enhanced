# Story 1.3: Create Migration Delta & Installer Updates

Status: done

## Story

As a user upgrading from v1.5.x,
I want the migration system to add all 3 new agents and 9 workflows to my existing config without losing my customizations,
So that I get the complete 7-agent Vortex through `npx bmad-update`.

## Acceptance Criteria

1. **AC1: Migration delta file exists and is registered**
   - **Given** a user upgrading from v1.5.x
   - **When** `npx bmad-update` runs
   - **Then** migration registry contains a `1.5.x-to-1.6.0` entry
   - **And** the entry lazy-loads `1.5.x-to-1.6.0.js` delta file
   - **And** the delta is marked `breaking: false`

2. **AC2: Migration delta appends new agents and workflows to config**
   - **Given** a v1.5.x config with 4 agents and 13 workflows
   - **When** the `1.5.x-to-1.6.0.js` delta `apply()` runs
   - **Then** 3 new agent IDs are appended: `research-convergence-specialist`, `hypothesis-engineer`, `production-intelligence-specialist`
   - **And** 9 new workflow names are appended: `research-convergence`, `pivot-resynthesis`, `pattern-mapping`, `hypothesis-engineering`, `assumption-mapping`, `experiment-design`, `signal-interpretation`, `behavior-analysis`, `production-monitoring`
   - **And** existing user customizations (`communication_language`, `user_name`, `party_mode_enabled`, etc.) are preserved (NFR3)
   - **And** if agents/workflows already contain the new entries (idempotency), they are NOT duplicated

3. **AC3: Migration delta has preview capability**
   - **Given** the migration delta
   - **When** `preview()` is called
   - **Then** it returns a list of human-readable actions describing what will change
   - **And** no file system changes occur during preview

4. **AC4: Manifest CSV contains 7 agent rows**
   - **Given** `install-vortex-agents.js` `createAgentManifest()`
   - **When** it generates the manifest CSV
   - **Then** it produces 7 rows (one per agent) with persona data from registry
   - **Note:** Already data-driven via `AGENTS.map()` (Story 1.1). Verify with test.

5. **AC5: postinstall.js displays all 7 agent names**
   - **Given** `postinstall.js`
   - **When** it prints the agent list
   - **Then** it displays all 7 agent names dynamically from registry
   - **Note:** Already data-driven via `AGENTS` import (Story 1.1). Verify output.

6. **AC6: Party Mode includes all 7 agents**
   - **Given** the agent manifest CSV generated by the installer
   - **When** Party Mode loads agents
   - **Then** all 7 agents are available for collaborative discussions
   - **Note:** Party Mode reads from `agent-manifest.csv`. Since manifest generation is data-driven (AC4), this is satisfied transitively. Verify CSV row count.

7. **AC7: Migration test covers delta logic**
   - **Given** a new test file `tests/unit/1.5.x-to-1.6.0.test.js`
   - **When** tests run
   - **Then** they verify: agents appended, workflows appended, idempotency, customizations preserved
   - **And** all existing tests (252+) pass — zero regressions (NFR4)
   - **And** `npm run lint` passes clean

8. **AC8: Installer E2E test passes with 7 agents**
   - **Given** the existing installer E2E test
   - **When** it runs
   - **Then** it verifies all 7 agents are installed
   - **Note:** Already updated in Story 1.1 to use registry-driven agent list. Verify still passes.

## Tasks / Subtasks

- [x] **Task 1: Create migration delta file `1.5.x-to-1.6.0.js`** (AC: 1, 2, 3)
  - [x] 1.1 Create `scripts/update/migrations/1.5.x-to-1.6.0.js` following existing delta pattern
  - [x] 1.2 Import `AGENT_IDS` and `WAVE3_WORKFLOW_NAMES` from `agent-registry.js`
  - [x] 1.3 Implement `preview()` that returns list of planned actions (append agents, append workflows)
  - [x] 1.4 Implement `apply(projectRoot)` that reads existing `config.yaml`, appends missing agents/workflows, writes back
  - [x] 1.5 Ensure idempotency: check if each agent/workflow already exists before appending
  - [x] 1.6 Preserve all existing config values (user customizations) — only modify `agents` and `workflows` arrays

- [x] **Task 2: Register migration in registry.js** (AC: 1)
  - [x] 2.1 Append `1.5.x-to-1.6.0` entry to `migrations` array in `scripts/update/migrations/registry.js`
  - [x] 2.2 Set `fromVersion: '1.5.x'`, `breaking: false`, lazy-load module path

- [x] **Task 3: Write migration delta tests** (AC: 7)
  - [x] 3.1 Create `tests/unit/1.5.x-to-1.6.0.test.js`
  - [x] 3.2 Test: `preview()` returns action list without modifying filesystem
  - [x] 3.3 Test: `apply()` appends 3 new agents to existing 4-agent config
  - [x] 3.4 Test: `apply()` appends 9 new workflows to existing 13-workflow config
  - [x] 3.5 Test: `apply()` preserves user customizations (communication_language, user_name, party_mode_enabled)
  - [x] 3.6 Test: `apply()` is idempotent — running twice produces same result (no duplicates)
  - [x] 3.7 Test: `apply()` handles config with no agents/workflows arrays gracefully

- [x] **Task 4: Verify data-driven behavior (already done in Stories 1.1/1.2)** (AC: 4, 5, 6, 8)
  - [x] 4.1 Verify `install-vortex-agents.js` `createAgentManifest()` produces 7-row CSV (grep for hardcoded agent names)
  - [x] 4.2 Verify `postinstall.js` uses `AGENTS` from registry for dynamic agent list
  - [x] 4.3 Verify installer E2E test passes with 7 agents
  - [x] 4.4 Run full test suite: `npm test && npm run test:integration && npm run lint`

## Dev Notes

### What's Already Done (Stories 1.1 + 1.2 Carry-Forward)

**Critical insight:** Most of this story's ACs are already satisfied by the data-driven architecture established in Stories 1.1 and 1.2:

| Component | Status | Why |
|-----------|--------|-----|
| `install-vortex-agents.js` manifest | ✅ Already 7 agents | `AGENTS.map()` from registry |
| `postinstall.js` agent list | ✅ Already 7 agents | Imports `AGENTS` from registry |
| `refreshInstallation()` file copying | ✅ Already 7 agents | Loops `AGENT_FILES`, `WORKFLOW_NAMES` |
| Party Mode (manifest CSV) | ✅ Already 7 rows | Generated from `AGENTS` array |
| Installer E2E test | ✅ Already 7 agents | `createValidInstallation()` uses registry |

**Only the migration delta and its tests need to be created.** Tasks 1-3 are new work. Task 4 is verification only.

### Migration Delta Pattern

All existing deltas follow this structure in `scripts/update/migrations/`:

```javascript
module.exports = {
  name: '1.5.x-to-1.6.0',
  fromVersion: '1.5.x',
  breaking: false,
  async preview() {
    return { actions: ['...describe changes...'] };
  },
  async apply(projectRoot) {
    // Read config.yaml, modify, write back
    return ['...log of applied changes...'];
  }
};
```

**Key architectural rule:** Migration deltas contain ONLY delta logic. `refreshInstallation()` handles file copying (agents, workflows, guides). The delta only needs to update the config arrays.

### Config.yaml Structure (what the delta modifies)

The delta reads `_bmad/bme/_vortex/config.yaml` and appends to:
- `agents: [...]` — append 3 new agent IDs if not present
- `workflows: [...]` — append 9 new workflow names if not present

A v1.5.x config will have:
```yaml
agents:
  - contextualization-expert
  - discovery-empathy-expert
  - lean-experiments-specialist
  - learning-decision-expert
workflows:
  - contextualize-scope
  - empathy-deep-dive
  # ... 13 total
```

After migration, it should have all 7 agents and 22 workflows.

### Registry Entry Pattern

In `scripts/update/migrations/registry.js`, append:
```javascript
{
  name: '1.5.x-to-1.6.0',
  fromVersion: '1.5.x',
  breaking: false,
  description: 'Add Wave 3 agents (Mila, Liam, Noah) and 9 workflows to config',
  module: null  // lazy-loaded
}
```

The `matchesVersionRange()` function handles `1.5.x` matching any `1.5.*` version.

### Idempotency Strategy

The delta must be idempotent (NFR7). Check before appending:
```javascript
const newAgents = WAVE3_AGENT_IDS.filter(id => !config.agents.includes(id));
config.agents.push(...newAgents);
```

This handles: (1) first-time upgrade, (2) re-running migration, (3) partial previous upgrade.

### Wave 3 Agent IDs and Workflow Names

From `agent-registry.js` (already defined in Story 1.1):

**New Agent IDs (3):**
- `research-convergence-specialist` (Mila — Synthesize)
- `hypothesis-engineer` (Liam — Hypothesize)
- `production-intelligence-specialist` (Noah — Sensitize)

**New Workflow Names (9):**
- `research-convergence`, `pivot-resynthesis`, `pattern-mapping` (Mila)
- `hypothesis-engineering`, `assumption-mapping`, `experiment-design` (Liam)
- `signal-interpretation`, `behavior-analysis`, `production-monitoring` (Noah)

These can be derived from the registry using `WAVE3_WORKFLOW_NAMES` set (added in Story 1.2 code review) and filtering `AGENTS` by Wave 3 streams.

### Test Pattern

Follow existing test patterns:
- Use `fs.mkdtemp` for temp directories
- Create mock `config.yaml` with `js-yaml`
- Call `apply(projectRoot)` and verify config changes
- Clean up temp dir in `after()`

### Files to Modify

| File | Change | Why |
|------|--------|-----|
| `scripts/update/migrations/1.5.x-to-1.6.0.js` | **NEW** — migration delta | AC1, AC2, AC3 |
| `scripts/update/migrations/registry.js` | Append new entry | AC1 |
| `tests/unit/1.5.x-to-1.6.0.test.js` | **NEW** — migration tests | AC7 |

### Files NOT Changing

- `scripts/install-vortex-agents.js` — already data-driven (AC4 is verification only)
- `scripts/postinstall.js` — already data-driven (AC5 is verification only)
- `scripts/update/lib/refresh-installation.js` — already handles all 7 agents
- `scripts/update/lib/migration-runner.js` — orchestration unchanged
- `scripts/update/lib/agent-registry.js` — source of truth, no changes
- `tests/helpers.js` — already registry-driven

### Learnings from Stories 1.1 + 1.2

- All test fixtures must use registry-driven data — never hardcode agent/workflow lists
- `createValidInstallation()` in `tests/helpers.js` already creates all 7 agents dynamically
- Wave 3 workflow names are available as `WAVE3_WORKFLOW_NAMES` set from registry
- P20 filename checks scoped to Wave 3 only — Wave 1/2 uses different naming
- Console silencing needed in tests that trigger heavy source-code logging (Node 20 IPC bug)
- Use isolated temp directories per test to prevent state leakage

### Project Structure Notes

- Migration deltas: `scripts/update/migrations/`
- Migration registry: `scripts/update/migrations/registry.js`
- Config path: `_bmad/bme/_vortex/config.yaml`
- All paths relative to `projectRoot` parameter

### References

- [Source: _bmad-output/planning-artifacts/epics.md — Story 1.3]
- [Source: _bmad-output/planning-artifacts/architecture.md — D6 (Migration Strategy)]
- [Source: scripts/update/migrations/registry.js — Existing migration entries]
- [Source: scripts/update/migrations/1.4.x-to-1.5.0.js — No-op delta pattern]
- [Source: scripts/update/lib/refresh-installation.js — File copying logic]
- [Source: _bmad-output/implementation-artifacts/1-1-expand-agent-registry-to-7-agents.md — Completion Notes]
- [Source: _bmad-output/implementation-artifacts/1-2-update-validator-config-merger-doctor-for-7-agents.md — Completion Notes]

## Dev Agent Record

### Agent Model Used

Claude Opus 4.6

### Debug Log References

### Completion Notes List

- All 8 ACs met: migration delta created (AC1), appends 3 agents + 9 workflows (AC2), preview capability (AC3), manifest 7-row (AC4 verified), postinstall dynamic (AC5 verified), party mode (AC6 verified), 7 new migration tests (AC7), E2E passes (AC8 verified)
- Delta imports `WAVE3_WORKFLOW_NAMES` from registry (not hardcoded Wave 1/2 list) — fully data-driven
- Wave 3 agent IDs derived by filtering `AGENT_IDS` against known Wave 1/2 IDs
- Idempotent: filters already-present entries before appending
- Updated `registry.test.js` to expect `1.5.x-to-1.6.0` entry for v1.5.x versions (was asserting 0 migrations for current version)
- AC4/5/6/8 were already satisfied by Stories 1.1/1.2 data-driven architecture — verified, no code changes needed

### Change Log
- 2026-02-24: Story created by create-story workflow. Status: ready-for-dev.
- 2026-02-24: Implementation complete. All tasks done. 199 unit + 60 integration = 259 tests pass, lint clean. Status: review.
- 2026-02-24: Code review complete. 6 fixes applied (M1: temp dir leak, M2: sync→async I/O, L1: preview() data-driven, L2: return value tested, L3: shebang removed, L4: count assertions). 259 tests pass, lint clean. Status: done.

### File List
- `scripts/update/migrations/1.5.x-to-1.6.0.js` — **NEW** Migration delta: appends Wave 3 agents/workflows to config (idempotent)
- `scripts/update/migrations/registry.js` — Appended `1.5.x-to-1.6.0` entry (breaking: false)
- `tests/unit/1.5.x-to-1.6.0.test.js` — **NEW** 7 tests: module shape, preview, append agents, append workflows, customization preservation, idempotency, missing arrays
- `tests/unit/registry.test.js` — Updated: `1.5.x` version now returns migration (was asserting 0), `getAllMigrations` count 5→6
